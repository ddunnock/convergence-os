# .github/workflows/sonarqube.yml
# SonarCloud Quality Gate Analysis for Pull Requests
#
# This workflow enforces code quality standards using SonarCloud:
# - Sonar Way for AI quality profile
# - 80% minimum code coverage on new code
# - All Quality Gate conditions must pass
#
# Required Secrets:
# - SONAR_TOKEN: SonarCloud authentication token
# - GITHUB_TOKEN: Automatically provided by GitHub Actions

name: SonarCloud Quality Gate

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

# Cancel in-progress runs when a new push occurs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 25

    # TODO: Uncomment when database setup is complete
    # services:
    #   # PostgreSQL service for integration tests
    #   postgres:
    #     image: postgres:16
    #     env:
    #       POSTGRES_USER: postgres
    #       POSTGRES_PASSWORD: postgres
    #       POSTGRES_DB: convergence_test
    #     ports:
    #       - 5432:5432
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history for SonarCloud blame information
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.24.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25"
          cache: "pnpm"

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: abatilo/actions-poetry@v4
      - name: Setup a local virtual environment (if no poetry.toml file)
        run: |
          poetry config virtualenvs.create true --local
          poetry config virtualenvs.in-project true --local
      - uses: actions/cache@v4
        name: Define a cache for the virtual environment based on the dependencies lock file
        with:
          path: ./services/ml/.venv
          key: venv-${{ hashFiles('services/ml/poetry.lock') }}
      - name: Install project dependencies
        run: cd services/ml && poetry install

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile

      - name: Build required packages
        run: |
          # TODO: Uncomment when database setup is complete
          # pnpm --filter @convergence/db build || true
          pnpm --filter @convergence/ui build || true
        # TODO: Uncomment when database setup is complete
        # env:
        #   DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test

      # TODO: Uncomment when database setup is complete
      # - name: Run database migrations
      #   run: pnpm --filter @convergence/db db:migrate || true
      #   env:
      #     DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test
      - name: Run TypeScript tests with coverage
        run: pnpm test:coverage
        # TODO: Uncomment when database setup is complete
        # env:
        #   DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test
        #   TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test

      - name: Run Python tests with coverage
        run: cd services/ml && poetry run pytest --ignore=tests/unit/test_api_routers.py
        # TODO: Uncomment when database setup is complete
        # env:
        #   DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test
        #   TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test
        #   CONVERGENCE_ML_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/convergence_test

      - name: Fix Python coverage paths for SonarQube
        run: |
          # Fix paths in coverage.xml to be relative to repository root
          if [ -f services/ml/coverage.xml ]; then
            # Replace filename="src/ with filename="services/ml/src/
            sed -i 's|filename="src/|filename="services/ml/src/|g' services/ml/coverage.xml
            echo "âœ… Fixed Python coverage paths"
          fi

      - name: Merge coverage reports
        run: |
          # Ensure coverage directory exists
          mkdir -p coverage

          # Copy Python coverage XML if it exists
          if [ -f services/ml/coverage.xml ]; then
            echo "Found Python coverage report"
            cp services/ml/coverage.xml coverage/python-coverage.xml || true
          fi

          # Collect TypeScript coverage from all packages
          echo "Collecting TypeScript coverage reports..."

          # Find all lcov.info files from package coverage directories
          TS_COVERAGE_FILES=$(find packages apps -name "lcov.info" -path "*/coverage/*" 2>/dev/null || true)

          if [ -n "$TS_COVERAGE_FILES" ]; then
            echo "Found TypeScript coverage files:"
            echo "$TS_COVERAGE_FILES"
            
            # Merge all lcov files into one (simple concatenation works for lcov format)
            cat $TS_COVERAGE_FILES > coverage/lcov.info
            echo "Merged TypeScript coverage file size: $(wc -c < coverage/lcov.info) bytes"
          else
            echo "No TypeScript coverage files found in packages/apps directories"
            # Create empty file to prevent failure if only Python tests ran
            touch coverage/lcov.info
          fi

      - name: Verify coverage reports
        run: |
          echo "ðŸ“Š Coverage reports status:"

          if [ -f coverage/lcov.info ] && [ -s coverage/lcov.info ]; then
            echo "âœ… TypeScript coverage found: $(wc -c < coverage/lcov.info) bytes"
          else
            echo "âš ï¸ TypeScript coverage empty or not found"
          fi

          if [ -f coverage/python-coverage.xml ]; then
            echo "âœ… Python coverage found: $(wc -c < coverage/python-coverage.xml) bytes"
          else
            echo "âš ï¸ Python coverage not found"
          fi

          # List all coverage files
          echo ""
          echo "Coverage directory contents:"
          ls -la coverage/ || echo "Coverage directory does not exist"

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.scm.revision=${{ github.sha }}
            -Dsonar.sources=packages,apps,services/ml/src
            -Dsonar.tests=packages,apps,services/ml/tests
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.next/**,**/coverage/**,**/__pycache__/**,**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx,**/test_*.py,**/*_test.py
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx,**/test_*.py,**/*_test.py
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info,packages/ui/coverage/lcov.info,apps/web/coverage/lcov.info
            -Dsonar.python.coverage.reportPaths=coverage/python-coverage.xml,services/ml/coverage.xml
            -Dsonar.sourceEncoding=UTF-8

      - name: Wait for Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt

      - name: Check Quality Gate Status
        if: always()
        run: |
          echo "ðŸ“Š SonarCloud Quality Gate Status"
          echo "=================================="
          echo ""
          echo "View detailed results at:"
          echo "https://sonarcloud.io/summary/new_code?id=${{ secrets.SONAR_PROJECT_KEY || 'convergence-os' }}&pullRequest=${{ github.event.pull_request.number }}"
          echo ""
          echo "Quality Gate Conditions:"
          echo "- âœ“ Coverage on New Code â‰¥ 80%"
          echo "- âœ“ Duplicated Lines (%) on New Code â‰¤ 3%"
          echo "- âœ“ Maintainability Rating on New Code = A"
          echo "- âœ“ Reliability Rating on New Code = A"
          echo "- âœ“ Security Hotspots Reviewed on New Code = 100%"
          echo "- âœ“ Security Rating on New Code = A"

      - name: Upload coverage report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
            services/ml/coverage.xml
            .scannerwork/report-task.txt
          retention-days: 30

# Quality Gate will fail the PR if any of these conditions are not met:
#
# NEW CODE CONDITIONS (Sonar Way for AI):
# ========================================
# 1. Coverage on New Code â‰¥ 80.0%
# 2. Duplicated Lines (%) on New Code â‰¤ 3.0%
# 3. Maintainability Rating on New Code = A
# 4. Reliability Rating on New Code = A
# 5. Security Hotspots Reviewed on New Code = 100%
# 6. Security Rating on New Code = A
#
# OVERALL CODE CONDITIONS:
# ========================
# 1. Security Hotspots Reviewed = 100%
#
# To configure these in SonarCloud:
# 1. Go to https://sonarcloud.io/organizations/YOUR_ORG/quality_gates
# 2. Create or edit Quality Gate
# 3. Set conditions as above
# 4. Assign to project: convergence-os
#
# IMPORTANT: Update the SonarCloud project key in the workflow:
# - Add SONAR_PROJECT_KEY secret with your actual SonarCloud project key
# - Or update the project key directly in the "Check Quality Gate Status" step
# - Format: organization_project-name (e.g., "ddunnock_convergence-os")
